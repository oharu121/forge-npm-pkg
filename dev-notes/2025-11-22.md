# Development Notes - November 22, 2025

## Dynamic GitHub Actions Version Fetching

### Overview
Implemented dynamic fetching of GitHub Actions major version tags, following the same pattern as npm package and Node.js version fetching.

### Implementation

**New Files:**
- `src/utils/actionsFetcher.ts` - Fetches latest major version tags from GitHub API
- `tests/actionsFetcher.test.ts` - Comprehensive test suite

**Modified Files:**
- `src/utils/generators/workflows.ts` - Updated `generateCIWorkflow()` to accept action versions
- `src/index.ts` - Fetches action versions in parallel, applies to CI and publish workflows
- `src/utils/generators/workflows.test.ts` - Updated tests to include action versions

### How It Works

1. **Parallel Fetching**: Action versions fetched alongside npm packages and Node.js versions
2. **GitHub API Query**: Fetches releases, extracts latest major version (v5, v6, etc.)
3. **Graceful Fallback**: If API fails, uses conservative defaults (v4/v5)
4. **Applied Everywhere**: Both CI and publish workflows use dynamic versions

### Supported Actions

- `actions/checkout` - Currently v5
- `actions/setup-node` - Currently v6
- `codecov/codecov-action` - Currently v5

### Benefits

- ‚úÖ New projects automatically get latest action versions
- ‚úÖ Follows existing pattern (npm/Node.js version fetching)
- ‚úÖ Zero maintenance - no manual updates needed
- ‚úÖ Security best practices - automatic security patches
- ‚úÖ Low risk - major version tags auto-update for patches

### Technical Details

**Action Version Fetcher:**
```typescript
export async function fetchLatestActionVersions(): Promise<Map<string, ActionVersionResult>> {
  // Fetches from: https://api.github.com/repos/{owner}/{repo}/releases
  // Extracts latest major version from release tags
  // Returns Map with fallback support
}
```

**Workflow Generator:**
```typescript
export function generateCIWorkflow(
  config: ProjectConfig,
  nodeConfig: NodeVersionConfig,
  actionVersions: Map<string, ActionVersionResult>  // New parameter
): string {
  const checkoutVersion = actionVersions.get('actions/checkout')?.version || 'v4';
  // Uses dynamic version in workflow template
}
```

---

## Interactive Release Script

### Overview
Created a production-ready interactive release automation script using `@clack/prompts`, matching the beautiful UX of the main tool.

### Implementation

**New Files:**
- `scripts/release.mjs` - Interactive release automation with comprehensive error handling
- `scripts/README.md` - Documentation for the release script

**Modified Files:**
- `package.json` - Updated scripts:
  - Changed `prerelease` ‚Üí `preversion` (npm hook)
  - Changed `release` ‚Üí `node scripts/release.mjs`

### The Release Workflow

The script automates the exact workflow I use manually:

1. **Sync** (optional) - `npm run sync` (pull + install + test)
2. **Test** - Runs full test suite
3. **Review Changes** - Shows `git status --short`
4. **Commit** - Prompts for commit message
5. **Version Bump** - Interactive selection (patch/minor/major)
6. **Push** - Pushes commits and tags (triggers CD)

### Features

**Interactive Prompts:**
```
üöÄ Release Tool

‚óÜ  Run npm run sync? (pull latest, install, test)
‚îÇ  Yes / No

‚óÜ  Commit these changes?
‚îÇ  Yes / No

‚óÜ  Commit message:
‚îÇ  feat: your message here

‚óÜ  Select version bump:
‚îÇ  ‚óè Patch (bug fixes) ‚Äî x.x.X
‚îÇ  ‚óã Minor (new features) ‚Äî x.X.0
‚îÇ  ‚óã Major (breaking changes) ‚Äî X.0.0

‚óÜ  Push to remote? (triggers CD workflow)
‚îÇ  Yes / No

‚îî  üéâ Release complete!
```

**Comprehensive Error Handling:**

Every git/npm command wrapped in try-catch:
- Merge conflicts during sync ‚Üí stops with clear error
- Test failures ‚Üí stops, shows failure
- Pre-commit hook failures ‚Üí stops with context
- Network issues during push ‚Üí version bumped locally, manual push instructions
- User abort (ESC) ‚Üí clean exit at any point

**Example Error Messages:**
```
‚ùå Failed to commit changes
‚îå  Common causes:
‚îÇ  ‚Ä¢ Pre-commit hooks failed
‚îÇ  ‚Ä¢ Commit message has special characters
‚îÇ  ‚Ä¢ Working directory has issues
‚îî  Fix the issue and try again
```

### Usage

```bash
npm run release
```

Then follow the interactive prompts. Can abort at any time with ESC key.

### Why This Approach?

**Evaluated Options:**
1. **`np`** - Popular but missing our sync step, less control
2. **`release-it`** - Too much configuration overhead
3. **Custom script** - ‚úÖ Exact workflow, full control, beautiful UX

**Decision: Custom Script**
- Already have `@clack/prompts` as dependency
- Matches our tool's UX perfectly
- Implements exact workflow (including sync)
- ~200 lines, fully understandable
- Easy to modify as needs change

### Technical Implementation

**Error Handling Pattern:**
```javascript
try {
  exec('git add .');
  exec(`git commit -m "${commitMsg}"`);
  clack.log.success('Changes committed');
} catch (error) {
  clack.log.error('Failed to commit changes');
  clack.log.error(error.message);
  clack.note(
    'Common causes:\n' +
    '  ‚Ä¢ Pre-commit hooks failed\n' +
    '  ‚Ä¢ Commit message has special characters',
    'Troubleshooting:'
  );
  exit(1);
}
```

**Abort Handling:**
```javascript
const shouldPush = await clack.confirm({
  message: 'Push to remote? (triggers CD workflow)',
  initialValue: true,
});

if (clack.isCancel(shouldPush) || !shouldPush) {
  clack.note('Push manually: git push && git push --tags');
  clack.outro('Release prepared');
  exit(0);
}
```

### Benefits

- ‚úÖ Same beautiful UX as main tool
- ‚úÖ Exact workflow I already use
- ‚úÖ Branch validation check (added later)
- ‚úÖ Abort anytime (ESC key)
- ‚úÖ Comprehensive error handling
- ‚úÖ Helpful error messages with recovery steps
- ‚úÖ Safe - never leaves repo in broken state
- ‚úÖ No new dependencies

### Branch Validation (Added Later)

After initial implementation, added branch check to prevent accidental releases from feature branches:

**Implementation:**
```javascript
// Step 1: Check current branch
const currentBranch = exec('git branch --show-current', true).trim();
const mainBranches = ['main', 'master'];

if (!mainBranches.includes(currentBranch)) {
  clack.log.warn(`You are on branch: ${currentBranch}`);
  clack.note(
    'Releases are typically made from main/master branch.\n' +
    'Publishing from a feature branch may cause issues.',
    '‚ö†Ô∏è  Warning:'
  );

  const shouldContinue = await clack.confirm({
    message: 'Continue anyway?',
    initialValue: false,
  });

  if (clack.isCancel(shouldContinue) || !shouldContinue) {
    clack.cancel('Release cancelled - switch to main branch first');
    exit(0);
  }
}
```

**Why This Matters:**
- Prevents version conflicts when merging feature branches
- Avoids creating git tags on wrong branches
- Stops CD workflow from triggering for non-main code
- Defaults to "No" for safety

**Updated Workflow:**
1. Check branch (new) ‚úÖ
2. Check remote
3. Pull if needed
4. Test
5. Review changes
6. Commit
7. Version bump
8. Push

### Future Enhancements

Possible additions:
- Option to edit CHANGELOG before version bump
- Show diff before commit
- Validate commit message format (conventional commits)
- Option to create GitHub release

For now, keeping it simple and focused on the core workflow.

---

## Summary

Today's work focused on completing the "zero maintenance" vision:

1. **Dynamic GitHub Actions Versioning** - Completed the trilogy (npm packages, Node.js, GitHub Actions)
2. **Release Automation** - Replaced broken script with production-ready interactive tool

Both implementations follow consistent patterns:
- Parallel execution for performance
- Graceful fallbacks for reliability
- Beautiful UX with `@clack/prompts`
- Comprehensive error handling
- Zero maintenance philosophy

The tool is now fully self-sufficient - all versions (packages, Node.js, actions) are fetched dynamically, and the release process is automated with a polished interactive experience.
