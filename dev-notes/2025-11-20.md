# Development Notes - November 20, 2025

## Major Feature: Dynamic Version Fetching

Implemented complete dynamic version fetching for both npm packages and Node.js LTS versions. The tool now always fetches the latest versions at scaffold time instead of using hardcoded versions.

### Changes Made

#### 1. Dynamic npm Package Version Fetching

**Files Created:**
- `src/utils/versionFetcher.ts` - Core version fetching utility

**Key Features:**
- Fetches latest versions from npm registry in parallel
- Smart fallback to stable versions (30+ days old) when fetch fails
- Warns users about risky new versions:
  - Major versions (x.0.x) released within 30 days
  - Early minor versions (x.1.x) released within 14 days
- Ultimate fallback to "latest" string if all else fails
- 5-second timeout per fetch request

**Files Modified:**
- `src/utils/generators/packageJson.ts`:
  - Made `generatePackageJson()` async
  - Made `generateDevDependencies()` async
  - Now dynamically fetches versions for: typescript, tsup, vitest, jest, eslint, prettier, etc.
  - Returns warnings array for user display

- `src/index.ts`:
  - Updated to handle async package.json generation
  - Added spinner message: "Fetching latest package versions from npm..."
  - Displays version warnings to users if any packages are too new

#### 2. Dynamic Node.js LTS Version Fetching

**Files Created:**
- `src/utils/nodeFetcher.ts` - Node.js LTS version fetcher

**Key Features:**
- Fetches active LTS versions from nodejs.org/dist/index.json
- Filters out EOL (End-of-Life) versions
- Returns configuration object with:
  - `minimum`: Minimum LTS version for engines field
  - `engines`: Engine string (e.g., ">=20.0.0")
  - `ciMatrix`: Array of LTS versions for CI testing (e.g., [20, 22])
  - `latestLTS`: Latest LTS version for publish workflow
- Built-in EOL date tracking
- Fallback to Node 20 & 22 if fetch fails

**Files Modified:**
- `src/utils/generators/packageJson.ts`:
  - Added `engines` field to generated package.json
  - Returns `nodeConfig` alongside packageJson and warnings

- `src/utils/generators/workflows.ts`:
  - Updated `generateCIWorkflow()` signature to accept `nodeConfig`
  - CI matrix now uses dynamic LTS versions
  - Codecov upload now uses latest LTS version instead of hardcoded '20'

- `src/index.ts`:
  - Publish workflow now uses dynamic Node version
  - Passes `nodeConfig` to CI workflow generator

### Benefits

**Zero Maintenance:**
- No more manual version updates every month
- Tool automatically uses latest versions when users run it
- Node.js LTS versions update automatically when new LTS releases

**Always Current:**
- Users get latest stable packages and Node versions
- No risk of scaffolding with outdated dependencies
- New major Node LTS (like Node 24 in October 2025) will be picked up automatically

**User Safety:**
- Warns about brand new major versions that might have breaking changes
- Fallback system ensures tool never fails completely
- Educational warnings help users understand risks

**Consistent:**
- Same Node versions used in CI matrix, publish workflow, and engines field
- Predictable behavior across all generated files

### Technical Details

**Version Fetching Strategy:**
```typescript
// Primary: Fetch from npm registry
fetch('https://registry.npmjs.org/typescript/latest')

// Fallback 1: Find stable version (30+ days old)
fetch('https://registry.npmjs.org/typescript')
// Filter versions by age

// Fallback 2: Use "latest" string
// npm resolves this during install
```

**Node.js LTS Logic:**
- Only considers versions with LTS flag (even numbers: 18, 20, 22, 24...)
- Checks EOL dates to exclude expired versions
- Uses latest 2 LTS versions for CI matrix
- Uses older of the two as minimum requirement (better compatibility)

### User Experience

**Before:**
```bash
$ npx forge-npm-pkg my-package -y
✓ Project created!
# Uses hardcoded versions from 2024
```

**After:**
```bash
$ npx forge-npm-pkg my-package -y
✓ Fetching latest package versions from npm...

⚠️  Package Version Warnings

⚠️  typescript@6.0.0 (3 days old)
   New major version - may contain breaking changes.
   If issues occur, downgrade: npm install typescript@5

✓ Project created with latest package versions!
```

### Generated Files Changes

**package.json now includes:**
```json
{
  "engines": {
    "node": ">=20.0.0"
  },
  "devDependencies": {
    "typescript": "^5.7.2",  // Latest fetched dynamically
    "vitest": "^2.1.5"       // Latest fetched dynamically
  }
}
```

**CI workflow now has:**
```yaml
strategy:
  matrix:
    node-version: [20, 22]  # Dynamic LTS versions
```

**Publish workflow uses:**
```yaml
- uses: actions/setup-node@v4
  with:
    node-version: '22.x'  # Latest LTS
```

### Future-Proofing

**When Node 24 LTS releases (October 2025):**
- Tool automatically updates to use [22, 24] in CI
- Engines becomes ">=22.0.0"
- Publish workflow uses 24.x
- No code changes needed!

**When TypeScript 6 releases:**
- Tool fetches 6.0.0
- Warns user it's only X days old
- User can downgrade if needed
- No manual version tracking required

### Risks Acknowledged

**Trade-offs we accepted:**
- Slightly slower (2-3 seconds for network calls)
- Requires internet connection (already needed anyway)
- New versions might have breaking changes
  - Mitigated by warnings
  - Users control when they run the CLI
  - Fallbacks ensure stability

**Not implemented:**
- Manual override flags (e.g., --use-stable)
- Version pinning in the CLI itself
- Caching fetched versions
  - Decision: Keep it simple, fetch fresh every time

### Testing Notes

- Built successfully with `npm run build`
- No type errors
- Ready for testing with actual npm registry
- Fallback logic tested conceptually but needs real-world validation

### Next Steps

1. Manual testing with actual scaffold
2. Verify warnings display correctly
3. Test fallback behavior (disconnect network)
4. Update README with new behavior
5. Update CHANGELOG for version 1.7.0
6. Consider adding integration tests for version fetching

## Changes Made

### 1. Removed --yes Flag

**Rationale:**
The `--yes` flag was designed to skip prompts and use recommended defaults, but this contradicts the philosophy of the tool - users should actively choose their configuration. Removing this flag ensures all users go through the interactive setup process and make informed decisions about their project configuration.

**Files Modified:**
- `src/index.ts`:
  - Removed `-y, --yes` option from CLI arguments
  - Removed `useDefaults` variable and all conditionals checking it
  - Removed logic that auto-selected defaults (TypeScript + Vitest + Linting)
  - All users now go through full interactive prompts
  - Removed simplified messages for default mode
  - Package manager selection now always prompts (no auto-detect bypass)
  - Configuration summary always shown with confirmation prompt

**Impact:**
- More intentional project setup
- Users understand all options available
- No "magic" defaults that users might not be aware of
- Better user experience with full transparency

### 2. Implemented Pre-Flight Update Check

**Rationale:**
Previously, update notifications appeared AFTER the user had already started scaffolding a project. This was frustrating because if they wanted to use the latest version, they'd have to cancel and restart. The new approach checks for updates BEFORE any work begins, allowing users to update first if desired.

**Implementation Details:**

**Files Modified:**
- `src/index.ts` (lines 48-52):
  ```typescript
  // Check for updates silently (we'll handle the prompt ourselves)
  const notifier = updateNotifier({
    pkg: packageJson,
    updateCheckInterval: 1000 * 60 * 60 * 24 // Check once per day
  });
  ```

- `src/index.ts` (lines 147-169 - after logo, before intro):
  ```typescript
  // Check for updates BEFORE starting the workflow
  if (notifier.update) {
    const { current, latest } = notifier.update;

    clack.note(
      `Current: ${current}\nLatest:  ${latest}\n\nChangelog: https://github.com/oharu121/forge-npm-pkg/releases/tag/v${latest}`,
      "⚠️  Update Available"
    );

    const shouldUpdate = handleCancel(
      await clack.confirm({
        message: "Update to latest version before continuing?",
        initialValue: true
      })
    );

    if (shouldUpdate) {
      clack.log.step("Restarting with latest version...");
      const args = process.argv.slice(2);
      execSync(`npx forge-npm-pkg@latest ${args.join(' ')}`, { stdio: 'inherit' });
      process.exit(0);
    }
  }
  ```

**Key Features:**
- ✅ Checks for updates at startup (before any prompts)
- ✅ Shows clear update notification with current and latest versions
- ✅ Includes direct link to GitHub release page with changelog
- ✅ Prompts user to update before continuing (default: yes)
- ✅ If yes: restarts with latest version using `npx forge-npm-pkg@latest`
- ✅ If no: continues with current version
- ✅ Preserves all command-line arguments when restarting
- ✅ Uses update-notifier's built-in caching (checks once per day)

**User Experience:**

**Before:**
```bash
$ npx forge-npm-pkg@1.5.0 my-package
# ... goes through entire setup ...
# ... after project created ...
Update available 1.5.0 → 1.6.0
Run `npm i -g forge-npm-pkg` to update
```

**After:**
```bash
$ npx forge-npm-pkg@1.5.0 my-package

FORGE npm-pkg

Version: v1.5.0

⚠️  Update Available

Current: 1.5.0
Latest:  1.6.0

Changelog: https://github.com/oharu121/forge-npm-pkg/releases/tag/v1.6.0

? Update to latest version before continuing? (Y/n) › Yes

◇  Restarting with latest version...
# Restarts with v1.6.0
```

**Benefits:**
- Prevents wasted time setting up with outdated version
- User can review changelog before updating
- Seamless upgrade experience
- No need to cancel and manually restart
- Arguments preserved across restart

### URL Format Decision

User requested using the GitHub releases tag URL format:
```
https://github.com/oharu121/forge-npm-pkg/releases/tag/v1.6.0
```

This format is preferred because:
- Direct link to release notes and changelog
- Users can see what changed before updating
- Standard GitHub URL pattern
- Shows full release details including assets

### Testing Notes

- Built successfully: `npm run build`
- No TypeScript errors
- Ready for manual testing:
  1. Test with outdated version: `npx forge-npm-pkg@1.5.0 test-pkg`
  2. Verify update prompt appears before any other prompts
  3. Test "Yes" path - should restart with latest
  4. Test "No" path - should continue with current version
  5. Verify arguments are preserved

### Next Steps

1. Manual testing of both features
2. Update CHANGELOG.md for version 1.7.0
3. Consider updating README if needed
4. Test edge cases (no internet, invalid version, etc.)
