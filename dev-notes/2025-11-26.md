# Development Notes - November 26, 2025

## Dependabot Auto-Merge Workflow

### Overview
Added automatic generation of a Dependabot auto-merge workflow when users opt-in to Dependabot. This allows patch and minor dependency updates to be automatically merged after CI passes, reducing maintenance burden.

### Implementation

**New/Modified Files:**
- `src/utils/generators/workflows.ts` - Added `generateDependabotAutoMergeWorkflow()` function
- `src/utils/generators/index.ts` - Exported the new function
- `src/utils/actionsFetcher.ts` - Added `dependabot/fetch-metadata` to supported actions
- `src/index.ts` - Creates workflow file + shows setup instructions
- `src/utils/generators/workflows.test.ts` - Added test suite for new workflow

### How It Works

When a user opts in to Dependabot:
1. Tool generates `.github/dependabot.yml` (existing)
2. Tool generates `.github/workflows/dependabot-auto-merge.yml` (new)
3. After project creation, clear setup instructions are displayed

**Generated Workflow:**
```yaml
name: Dependabot Auto-Merge

on:
  pull_request_target:
    types: [opened, synchronize, reopened]

permissions:
  contents: write
  pull-requests: write

jobs:
  auto-merge:
    runs-on: ubuntu-latest
    if: github.actor == 'dependabot[bot]'

    steps:
      - name: Fetch Dependabot metadata
        id: metadata
        uses: dependabot/fetch-metadata@v2
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Auto-approve patch and minor updates
        if: steps.metadata.outputs.update-type != 'version-update:semver-major'
        run: gh pr review --approve "$PR_URL"
        env:
          PR_URL: ${{ github.event.pull_request.html_url }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Enable auto-merge for patch and minor updates
        if: steps.metadata.outputs.update-type != 'version-update:semver-major'
        run: gh pr merge --auto --squash "$PR_URL"
        env:
          PR_URL: ${{ github.event.pull_request.html_url }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
```

### User Instructions After Project Creation

When Dependabot is enabled, users see:

```
> Dependabot Auto-Merge Setup:

  To enable automatic merging of Dependabot PRs, configure these GitHub settings:

  1. Enable auto-merge for your repository:
     Settings � General � Pull Requests �  Allow auto-merge

  2. Allow GitHub Actions to approve PRs:
     Settings � Actions � General � Workflow permissions
     �  Allow GitHub Actions to create and approve pull requests

  Once configured, patch and minor updates will be auto-merged after CI passes.
  Major updates will still require manual review.
```

### Design Decisions

**Why Native GitHub Instead of Mergify (from the article)?**
- No third-party service dependency
- Free (Mergify has usage limits)
- Uses GitHub's built-in auto-merge feature
- Simpler - one workflow file vs Mergify config + workflow

**Why Squash Merge?**
- Clean git history
- No version bump needed for dependency updates
- Easy to revert if needed

**Why Skip Major Updates?**
- Major updates can have breaking changes
- Require manual review and testing
- User should consciously decide to upgrade

### Technical Details

**Dynamic Action Version:**
- Added `dependabot/fetch-metadata` to `SUPPORTED_ACTIONS`
- Fallback version: `v2`
- Fetched in parallel with other action versions

**Workflow Behavior:**
- Uses `pull_request_target` for security with Dependabot PRs
- `GITHUB_TOKEN` is automatic - no setup required
- Auto-approve + enable auto-merge (GitHub handles the rest)
- CI must pass before merge (branch protection acts as safety net)

### Benefits

-  Zero-maintenance dependency updates for patch/minor versions
-  Security patches auto-applied
-  CI runs before merge (safety net)
-  Major updates still require review
-  No third-party services needed
-  Clear setup instructions for users

---

## GitHub Repository Creation (Optional)

### Overview
Added optional GitHub repository creation using the `gh` CLI. When git is initialized and `gh` CLI is available and authenticated, users are prompted to create a GitHub repository.

### Implementation

**New Files:**
- `src/utils/ghCli.ts` - GitHub CLI utility functions
- `src/utils/ghCli.test.ts` - Test suite with mocked execSync calls

**Modified Files:**
- `src/index.ts` - Integrated repo creation prompt after git init

### How It Works

```
┌─────────────────────────────────────────────────────┐
│ After git init + commit:                            │
│                                                     │
│ 1. Check: isGhCliReady() (available + authenticated)│
│    └─ If no → silently skip, no prompt shown        │
│                                                     │
│ 2. Check: Does repo name already exist?             │
│    └─ If yes → info message, skip prompt            │
│                                                     │
│ 3. Show prompt:                                     │
│    ◆ Create GitHub repository?                      │
│    │ ○ Public repository                            │
│    │ ○ Private repository                           │
│    │ ● Skip - I'll create it manually               │
│                                                     │
│ 4. If not skip → run gh repo create                 │
│    └─ On failure → warn + show manual command       │
└─────────────────────────────────────────────────────┘
```

### Key Functions

```typescript
// Check if gh CLI is ready
isGhCliReady(): boolean

// Check if repo already exists
doesRepoExist(name: string): boolean

// Create repo and push
createGitHubRepo(options: CreateRepoOptions): CreateRepoResult

// Get manual command for fallback
getManualRepoCommand(name, isPrivate, description): string
```

### Design Decisions

**Why Optional?**
- Not everyone uses `gh` CLI
- Not everyone wants auto-creation
- Keeps the tool focused on scaffolding

**Why Silent Skip?**
- Users without `gh` don't need a warning
- Reduces noise for users who intentionally don't use `gh`

**Why Check Existing Repos?**
- Prevents confusing errors if repo already exists
- User-friendly message instead of API error

**Why Personal Account Only?**
- Org selection adds complexity
- Most npm packages are personal projects
- Can add org support later if needed

### Benefits

- ✅ Truly "zero to published" experience for gh users
- ✅ Graceful fallback with manual command
- ✅ No extra prompts for non-gh users
- ✅ Repo name conflict detection
- ✅ Uses package description automatically

---

## Summary

Today's work added two features:

1. **Dependabot Auto-Merge** - When Dependabot is enabled, generates a workflow that auto-approves and auto-merges patch/minor updates

2. **GitHub Repository Creation** - Optional prompt to create GitHub repo using `gh` CLI (only shown if gh is available and authenticated)

Both features follow the philosophy of reducing manual steps while keeping things optional and graceful.
